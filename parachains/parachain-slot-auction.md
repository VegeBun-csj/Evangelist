# 平行链插槽拍卖

要将一个平行链添加到波卡，它必须占用一个可用的平行链插槽。平行链插槽在波卡上是一种稀缺资源，只有有限的数量可以使用。随着平行链的数量的提升，每隔几个月可能只会有几个插槽被解锁。目标是最终在Polkadot上有100个平行链槽(这些将被平行链和平行线程池分开)。如果一个平行链想要在每个中继链块上确保并被包含，它必须获得一个平行链插槽。

平行链插槽将根据无许可的略有修改的蜡烛拍卖出售，以确保区块链上的安全性。

[![auction](https://cdn.jsdelivr.net/gh/VegeBun-csj/Images/auction.jpeg)](https://www.youtube.com/watch?v=i5-Rw2Sf7-w)

## 蜡烛拍卖的机制
蜡烛拍卖是公开拍卖的一种变体，在公开拍卖中，出价越来越高，拍卖结束时出价最高的人被认为是赢家。

蜡烛拍卖最初是在16世纪用于出售船只，得名于决定拍卖开放时间的“蜡烛尺寸”。当火焰熄灭，蜡烛熄灭，拍卖会突然终止，此时站着出价的人会赢得拍卖。

当蜡烛拍卖在网络上使用时，它们需要一个随机数来决定终止的时刻。平行链插槽拍卖与普通蜡烛拍卖略有不同，因为它们不会随机终止拍卖。相反地，它们会在一个固定的时间内运行，赢家是随机选择的。

波卡的蜡烛拍卖分为两部分:拍卖开始后立即生效的*开盘期*。这段时间持续一天18个小时，并会作为平行链候选人设置他们的初始出价的缓冲时间，同时可能开始执行他们的策略，如何赢得席位拍卖。在开盘期，投标会继续被接受，但它们不会对拍卖结果产生任何影响。

开盘期随后会过渡到一个持续5天的*结束期*，其中拍卖是根据蜡烛拍卖机制结束。

拍卖结束时间可以是该结束时间内的任何时间，并由[可验证随机函数(VRF)](https://wiki.polkadot.network/docs/learn-randomness##vrf)自动随机选择。赢得拍卖的概率等于中标的区块数除以结束期间的总区块数。通过在整个结束期间传播来管理随机结束，其中在结束期间的每个块上获取快照，以捕获该块期间的获胜者。在这段时间结束时，随机选择一张快照来决定拍卖的获胜者。

这个过程在结束期之后的下一个epoch(在波卡上持续6个小时)执行。**在VRF选择的结束时间内出价最高的平行链候选人赢得插槽拍卖**。

> 当拍卖的获胜者区块正在链上确定时，[众贷捐款](https://wiki.polkadot.network/docs/learn-crowdloans##supporting-a-crowdloan-campaign)不能在这六个小时内进行。

波卡的“平行链拍卖”从开始的从开始的1周的1天18个小时开始，到结束的5天(蜡烛拍卖阶段)，再到决定拍卖获胜者的6个小时。

关于这一点的更多细节可以在[波卡实现](https://wiki.polkadot.network/docs/learn-auction#polkadot-implementation)部分找到。

### 随机选择
> 随机性例子
下面的例子将展示kusama的第9次蜡烛拍卖的随机性机制。请记住，蜡烛阶段有一个统一的终止配置文件，并有一个在任何给定的块结束的平等的概率，并且终止块不能在拍卖之前或期间被预测。
> - 拍卖9在[`9362014`](https://kusama.subscan.io/extrinsic/0x7b67d653c9522b623a97e20a967b83a8517fe3821370475ddb6611cd37c29a03?event=9335014-26)区块开始。    
拍卖的完整持续时间等于`9362014` + `72000`号区块    
这里区块`72000`为“结束期”，共分为20个区块的3600个样本。形象地说，蜡烛被点燃，蜡烛阶段持续72000块。
> - 在最后阶段获胜的样本的指数为`1078`。    
样本1078为获胜者   
1078样本为`9362014` + `21560`区块的赢家，即`9383574`区块。    
> - 父块是“日志”中的一个新的BABE会话，它更新了用于选择样本索引的随机性。    
检查块状态
您可以检查块`9434277`结尾的状态，并查看带有存档节点的示例索引。`9434277`的“日志”中的摘要是可解码的，包含随机值以及BABE授权。
> 结果是，这次拍卖的获胜者并不是整个拍卖期间的最高出价。

## 基本原理
区块链系统的开放和透明特性开放了传统拍卖格式中不存在的攻击向量。当通过互联网或区块链实现时，普通的公开拍卖尤其容易受到拍卖狙击的影响。

拍卖“狙击”指的是拍卖结束时，竞标者不愿提前给出真实价格，希望支付的价格低于他们对物品的实际估价。

例如，爱丽丝可能会在拍卖会上为一件物品估价30美元。她提交了10美元的初始出价，希望以较低的价格获得项目。爱丽丝的策略是逐步提高出价，直到超过她的真实价值30美元。另一个竞标者夏娃对相同的物品评估价值为11美元。伊芙的策略是观察拍卖，并在最后一秒提交11美元的出价。在拍卖结束前，爱丽丝将没有时间对这个出价作出反应，并将失去这个物品。拍卖机制是次优的，因为它没有发现该物品的真实价格，并且该物品尚未交给最重视它的人。

在区块链上，这个问题可能会更糟，因为它有可能使该区块的生产者有机会通过添加/或忽略其他出价来窃取最后一个结论区域的拍卖。还有一种可能性是，恶意投标人或区块生产者试图通过狙击拍卖来打击诚实的投标人。

因此，[Vickrey拍卖](https://en.wikipedia.org/wiki/Vickrey_auction)(第二价格拍卖的变体，竞价是隐藏的，只有在后期才会公布)成为备受关注的机制。例如，它被实现为在ens上拍卖人类可读姓名的机制。蜡烛拍卖是另一个不需要两步提交和显示方案(Vickrey拍卖的主要组成部分)的解决方案，因此可以让智能合约参与。

蜡烛拍卖让每个人总是知道出价的状态，但不知道拍卖何时会结束。这有助于确保投标人愿意尽早提交真实的报价。否则，他们可能会发现自己处于这样一种情况:拍卖甚至在他们出价之前就已经确定结束了。

## 波卡实现
波卡将使用基于VRF的*随机信标*，该信标也用于协议的其他地方。VRF将提供随机性的基础，它将追溯地决定拍卖的结束时间。

时段最长为2年，并分为3个月的时段;平行链可以租用槽位的任何时间组合。平行链可以在一段时间内租用多个插槽，这意味着他们可以通过租用一个连续插槽来延长他们在波卡的租期。

> 个别平行链插槽时可替代的
这意味着平行链不需要总是驻留在同一个槽中，但只要一个平行链留在任何槽中，它就可以继续作为平行链存在。

## 投标
多个平行链或一个平行链团队可以通过指定他们想要租赁的插槽范围以及他们愿意保留的代币数量在拍卖中投标。竞标者可以是普通账户，也可以使用[众贷](https://wiki.polkadot.network/docs/learn-crowdloans)功能从社区中获取代币。

Parachain slots at genesis

       --3 months--
           v          v
    Slot A |     1    |     2     |     3     |     4     |     5     |     6    |     7     |     8     |     9     |...
    Slot B |     1    |     2     |     3     |     4     |     5     |     6    |     7     |     8     |     9     |...
    Slot C |__________|     1     |     2     |     3     |     4     |     5    |     6     |     7     |     8     |     9     |...
    Slot D |__________|     1     |     2     |     3     |     4     |     5    |     6     |     7     |     8     |     9     |...
    Slot E |__________|___________|     1     |     2     |     3     |     4    |     5     |     6     |     7     |     8     |     9     |...
           ^                                                                                             ^
           ---------------------------------------------max lease-----------------------------------------

*范围1 - 4的每一段表示为期3个月，共2年*

投标人将提交投标配置，指定他们愿意担保的代币数量和期限。插槽的范围可以是1 - `n`的任何时期，其中`n`是一个插槽可用的时期的数量(Polkadot和Kusama的`n`都为8)。

>如果你将代币与平行链插槽绑定，你不能用这些代币质押。在这种情况下，你通过放弃获得质押奖励的机会来购买平行链插槽。

单个投标方的投标方配置可能类似于下面的伪代码示例
```javascript
const bids = [
  {
    range: [1, 2, 3, 4, 5, 6, 7, 8],
    bond_amount: 300,
  },
  {
    range: [1, 2, 3, 4],
    bond_amount: 777,
  },
  {
    range: [2, 3, 4, 5, 6, 7],
    bond_amount: 450,
  },
];
```
从这个例子中要理解的重要概念是，投标人可以以不同的价格(`bond_amount`)提交不同的配置。然而，这些投标中只有一个有资格胜出，其他投标除外。

获胜者选择算法将挑选可能不重叠的投标，以便在平行链插槽的整个租期内最大化持有的代币数量。这意味着，任何给定插槽租期的最高出价者可能并不总是获胜者([见下面的例子](https://wiki.polkadot.network/docs/learn-auction#examples))。

一个基于Polkadot使用的VRF的随机数在每个块上确定。此外，每次拍卖的阈值从0开始，并增加到1。VRF产生的随机数在阈值附近进行检查，以确定该块是否是所谓的结束周期内拍卖的末端。此外，VRF将从最后一个时期选择一个区块(以减少来自恶意验证人的某些类型的攻击)

### 例子
有一个平行链插槽可用时。    
在1 - 8的范围内，查理出价`75`。   
戴夫对5 - 8的范围出价`100`。   
艾米丽对1 - 4的范围出价`40`。

让我们根据算法计算每个投标人的估值。我们通过将绑定质押金额乘以在特定竞价范围内的周期数来做到这一点。  
查理- 在范围1 - 8内为75 * 8 = 600  
戴夫- 在范围5 - 8内为100 * 4 = 400   
艾米丽- 在范围1 - 4内为40 * 4 = 160

虽然根据代币金额，戴夫的出价最高，但当我们进行计算时，我们看到，由于他只出价4个范围，他将需要与出价低得多的艾米丽共享位置。戴夫和艾米丽的出价加起来只相当于`560`的估价。

查理对整个系列的估价是600。因此，查理获得了平行链插槽的全部范围。

## FAQ
### 为什么不是每个人都竞拍最大长度呢?
在插槽的持续时间内，拍卖中的代币将被锁定。这意味着，将这些代币用于其他用途的可能性存在机会成本。对于对波卡多有利的平行链，应该使平行链和波卡中继链之间的利益保持一致。

### 这种机制是如何帮助确保平行链多样性的?
将平行链槽划分为多个区间的方法，是受希望增加平行链多样性的启发，并防止特别大、资金充足的平行链囤积槽。通过将每个时间段设定为3个月，但将整个时间段设定为2年，该机制可以应对资金充足的平行链，确保他们在租期结束时获得一个时间段，同时逐渐允许其他平行链进入生态系统，占据没有被填满的时间段。例如，如果一个大的，资金充足的平行链已经获得了一个范围1 - 8的插槽，他们将非常有兴趣获得下一个将开放2 - 9的插槽。在这种机制下，平行链可以只获得周期9(因为这是它唯一需要的)，并允许第二个平行链槽的2 - 8范围被另一个占用。

### 为什么区块链上的随机性很难?
随机性对于区块链系统来说是个问题。在一个透明和开放的网络上生成一个去信任的随机数，其中的其他各方必须能够验证，这为行动者试图改变或操纵随机性打开了可能性。已经提出了一些解决方案，包括像[RANDAO](https://github.com/randao/randao)这样的洋葱和[可验证随机函数](https://en.wikipedia.org/wiki/Verifiable_random_function)(vrf)。Polkadot将后者作为其随机性的基础。


### 除了蜡烛拍卖，还有其他获得插槽的方式吗?
除了蜡烛拍卖之外，获得平行链插槽的另一种方式是通过二级市场，已经赢得平行链插槽的参与者可以将该槽连同锁定到另一个买家的相关代币存款转售。这将允许卖方用平行链插槽换取流动的代币，而买方可以获得该槽以及存放的代币。

中继链的[治理机构](https://wiki.polkadot.network/docs/learn-governance)可以授予一些系统或公用平行链的插槽。系统平行链的平行链ID小于1_000，公益平行链的平行链ID在1_000 ~ 1_999之间。其他平行链的id为2000或更高。这些平行链不需要竞标或更新它们的位置，因为它们被认为对生态系统的未来至关重要。

## 资源
- [平行链分配](https://w3f-research.readthedocs.io/en/latest/polkadot/overview/3-parachain-allocation.html)- W3F关于平行链分配的研究页面，更深入的机制

- [研究更新:蜡烛拍卖的案例](https://polkadot.network/blog/research-update-the-case-for-candle-auctions/)- W3F分解和蜡烛拍卖的研究更新

- [前沿,智能合约和蜡烛拍卖](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3846363)W3F研究团队讨论如何补救当前的区块链拍卖缺点与蜡烛拍卖






































