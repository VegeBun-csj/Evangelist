# Staking
波卡使用NPOS(Nominated proof-of-stake)作为其共识机制。系统鼓励DOT持有者去参与成为提名人。提名人最多可以选择16个验证人作为受信任的验证人候选者。验证人和提名人都会将他们的代币锁定作为抵押，并接收质押奖励。

整个质押系统基本上在不考虑质押的情况会平等地向所有验证人支付奖励。在一个验证人上投入更多质押并不会影响它收到的块奖励的数量。然而，奖励计算存在概率成分，所以在特定时间段，奖励对于所有的验证人可能不完全相同。

在扣除验证人的基本质押金额后，奖励会按比例分配给所有的质押参与者。通过这种方式，网络为具有较低质押金额的验证人创造了提名激励，从而创建一个平等质押的验证人集合。

## 波卡中的质押是如何工作的？
### 1.确定你是哪种角色
在质押中，你可以是[提名人或者是验证人](https://wiki.polkadot.network/zh-CN/docs/learn-staking#validators-and-nominators)   
作为一个提名人，你可以提名验证人候选者，也就是你信任可以帮助你赚取链的原生代币的一个角色。赚取的奖励可以立即绑定(锁定)在您的帐户进行质押，也就是说随着时间的推移，你可以有效地复用你所获得的奖励。你也可以选择将奖励存储到你的账户，或者是另一个账户作为可用(可转移)余额。你可以参考[提名人指南](https://wiki.polkadot.network/zh-CN/docs/learn-nominator)来理解作为一个提名人的职责，以及[验证人文档](https://wiki.polkadot.network/zh-CN/docs/learn-validator)来了解需要做什么才能成为一个验证人。

如果你是一个新手并且想要通过Polkadpt JS APP安全地质押你的代币，可以看下面的视频
<iframe width="560" height="315" src="https://www.youtube.com/embed/FCXC0CDhyS4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

### 2.质押系统概述
任何一个潜在的验证人都会想他们成为一个验证人候选者。系统中的候选人会向所有提名人公开，而提名人则提交其支持的最多16名候选人的名单。在下一个阶段，一定数量的拥有最多DOT支持的验证人会被选中并活跃起来。作为一个提名人，最少需要10个DOT来提交提名意向。提名意向被放在一个半排序的列表中，称为[“包列表(bag-list)”](https://github.com/paritytech/substrate/pull/9507)。包列表有两个主要组件，包和节点。列表由包组成，每个包都描述了一系列活跃的绑定的资产(例如，第一个包会有0->10 DOT的提名人，第二个包会有11->20DOT的提名人，等等)。每个包中是一个节点列表，对应于一个提名人以及他们的质押资产。

bag-list这个pallet被设计为自我维护的，只需区块链付出最少的代价，就能使其具有极大的可伸缩性。让我们通过一个示例来探讨包列表的排序功能。在下面的包列表中，3个包中放置了8个节点。可以观察到，包内的节点列表是根据它们的插入顺序排列的，而不是基于绑定的代币数量。例如，包1中的节点是这样排列的:15->12->19

![baglist](https://cdn.jsdelivr.net/gh/VegeBun-csj/Images/801652109515_.pic.jpg)

假设提名人持有19个DOT，绑定2个DOT。这个操作会把这个提名人节点放在袋2中，就在DOT为27的节点之后。
> Info    
诸如绑定/解绑定代币之类的动作会自动重新组装包节点，但是诸如质押奖励/S销毁之类的事件却没有！Bags-List这个pallet拥有一个重要的无许可外部外部调用：`Rebag`。这使任何人都可以指定错误的袋子中的另一个帐户，然后将其放入正确的帐户中。检查袋子列表部分以获取更多信息。

![baglist](https://cdn.jsdelivr.net/gh/VegeBun-csj/Images/931652780320_.pic.jpg)

这种分类功能对于质押/选举系统的[长期改进](https://gist.github.com/kianenigma/aa835946455b9a3f167821b9d05ba376)非常重要。Bags-List能够包含无限数量的节点，但要遵守链的运行时存储。在当前的质押系统配置中，包列表保留了50000个提名意向，其中22,500名作为选举提名人出现。查看[订阅选举阶段](https://wiki.polkadot.network/docs/learn-nominator#staking-election-stages)部分以获取更多信息。

> 获得奖励的最少活跃提名阈值
提交提名意向并不能确保获得奖励。前22,500个提名人的质押会应用于验证人活跃的集合中。为了确保能够获得质押奖励，确保被绑定的代币数量高于最低活跃提名。有关更多信息，请查看[提名人指南](https://wiki.polkadot.network/docs/learn-nominator)

提名期结束后，NPOS选举机制会以提名意向及相关投票作为输入，并输出一组验证人。包被从最多的质押到最少的质押进行迭代。这可能会让最后一个接触到的包只被部分迭代。这意味着在某些边界情况下，包内成员的顺序也很重要。回想一下，在每个包中，迭代顺序就是插入顺序。如果只有7个节点被选为选择集，那么拥有5和7个点的节点将被选中，拥有8个点的节点将会被忽略。bag-list pallet附带一个外部变量:`putInFrontOf`，它帮助节点在包中向前移动。有关更多信息，请查看[bag-list](https://wiki.polkadot.network/docs/learn-nominator#bags-list)部分。

![baglist](https://cdn.jsdelivr.net/gh/VegeBun-csj/Images/941652789684_.pic.jpg.jpg)


“选举解决方案”必须满足某些要求，例如最大化提名验证人的权质押额，尽可能均匀地分配支持验证者的质押。这种选举机制的目标是最大限度地提高网络的安全性，并实现候选人的公平代表。如果你想了解更多关于NPOS的工作原理(例如选举、运行时间复杂性等)，请阅读[这里](http://research.web3.foundation/en/latest/polkadot/NPoS.html)。    
我们希望每个提名者仔细跟踪他们支持的验证者的表现和声誉。提名不是一种“设定好就忘掉”的操作。 

### 3.质押奖励分配
为了解释奖励是如何支付给验证人和提名人的，我们需要考虑验证人池。验证人池由被选出的验证人的质押以及支持它的提名人组成。

如果一个提名人`n`用质押金额`s`支持几个被选举的验证人,k的意思就是，NPOS选举机制将其质押金额分割成块`s_1`,`s_2`,.......,`s_k`,所以它支持验证人i的质押金额为`s_i`。在这种情况下,如果这k个提名人在不同的池,每一个支持一个验证人`i`的质押金额为`s_i`，那么提名人`n`就收到相同的奖励。

对于每个验证人池，我们保留一个带有相关质押金额的提名人列表。

跨验证人池的奖励的一般规则是，两个验证人池在相同的工作中获得本质上相同数量的代币，也就是说，它们的报酬不是与每个验证人池中的质押成比例。以[era分数](https://wiki.polkadot.network/docs/maintain-guides-validator-payout##era-points)和[小费](https://wiki.polkadot.network/docs/learn-transaction-fees#fee-calculation)的形式质押的奖励存在概率成分，但这些成分应该随着时间的推移而平均化。

在一个验证器人中，一定比例(可配置)的奖励将支付给验证人提交区块的费用，其余的将按比例(即按质押比例)支付给提名人和验证人。特别要注意的是，验证人会得到两次奖励:一次是来自验证的提交区块的佣金(如果他们的佣金率高于0%)，一次是来自提名自己的质押。如果验证人的佣金设置为100%，那么将不会向其验证人池中的任何提名人支付代币奖励。

为了评估通货膨胀率,以及每个月你作为提名人或验证人可以得到多少代币,您可以使用这个[工具](https://www.stakingrewards.com/earn/polkadot/calculate)作为参考,它通过改变一些参数(如你想质押多少天DOT,费用,复合奖励,等等)得到一个更好的估算。尽管它可能不完全准确，因为质押人的参与是动态变化的，但它是一个很好的指标。

### 4.奖励机制
我们强调了这个支付方案的两个特点。第一个是，由于验证人池的报酬与质押水平无关，因此质押较少的池通常会比质押较多的池向每个代币的提名人支付更多的报酬。

因此，我们为提名人提供经济激励，使他们逐渐将偏好转向获得足够声誉的风险较小的验证人。这样做的原因是，我们希望跨验证器池的质押尽可能均匀地分布，以避免权力集中在少数几个验证人手中。

从长期来看，我们预计所有验证人池都有类似的质押水平，声誉越高的验证人的利益越高(这意味着提名人愿意冒更大的风险，支持声誉较低的验证人，以获得更多的报酬)。   

下面的示例应能阐明上述内容。为了简单起见，我们有以下假设：
- 这些验证人没有自己的质押。
- 他们每个人都有相同数量的era分数。
- 任何交易都没有消费。
- 他们不收取任何提交区块的奖励。
- 总奖励金额为100个DOT代币。
- 当前作为验证人的最小DOT数量是350(注意，这不是实际的值，它是波动的，而仅仅是本例的一个假设;要了解实际最小赌注是如何计算的，请参阅[这里](https://wiki.polkadot.network/docs/faq#what-is-the-minimum-stake-necessary-to-be-elected-as-an-active-validator)。

|   | **A-Validator** |  |   |
| :-----| ----: | :----: |  :----: |
| Nomnation(4) | Stake(600) | Fraction of the Total Stake | Rewards |
| Jin | 100 | 0.167 | 16.7 |
| **Sam** | 50 | 0.083 | 8.3 |
| Anson | 250 | 0.417 | 41.7 |
| Bobby | 200 | 0.333 | 33.3 |

|   | **B-Validator** |  |   |
| :-----| ----: | :----: |  :----: |
| Nomnation(4) | Stake(400) | Fraction of the Total Stake | Rewards |
| Alice | 100 | 0.25 | 25 |
| Peter | 100 | 0.25 | 25 |
| John | 150 | 0.375 | 37.5 |
| **Kitty** | 50 | 0.125 | 12.5 |

两个验证人池A和B都有4个提名人，总质押分别为600和400。

基于上述奖励分配，在验证人池B中的提名人每个DOT比在池A中的提名人获得更多奖励，因为池A拥有更多的总质押。Sam在池A中质押了50 DOT，但他只能得到8.3，而Kitty以同样的质押获得了12.5。

关于奖励，还有一个额外的因素需要考虑。虽然一个验证人可以拥有的提名人的数量没有限制，但验证人可以支付奖励的提名人的数量是有限制的。

在Polkadot和Kusama，这个限制目前是256，尽管这可以通过Runtime升级修改。超过256个提名者的验证器是超额订阅的。当支付发生时，只有前256名的提名人(以分配给验证人的质押数量衡量)将获得奖励。所有其他提名人本质上都是在“浪费”他们的质押——他们用自己的提名来选举那个验证者成为活跃的收集人，但却没有因此获得回报。

我们还注意到，当网络因为一个错误行为(例如验证器离线，模棱两可等)而削减验证人槽时，削减的金额是一个固定的百分比(而不是一个固定的金额)，这意味着拥有更多质押金额的验证人池将被削减更多的DOT。，这样做是为了给提名人提供一种经济激励，让他们改变自己的偏好，支持他们认为值得信任的、不那么受欢迎的验证者。

需要注意的第二点是，每个验证人候选者都可以自由指定他们想要的提交区块佣金(作为奖励的百分比)，以弥补运营成本。由于验证池的报酬相同，佣金较低的池比费用较高的池向提名人支付更多的费用。因此，每个验证人可以选择提高他们的费用来赚取更多，或降低他们的费用来吸引更多的提名人，以增加他们被选上的机会。从长远来看，我们期望所有的验证人都需要具有成本效率以保持竞争力，并要求验证人具有较高的声誉

## 账户
有两个不同的账户来管理你的资金:`隐藏账户`和`控制器账户`。


。。。待添加图


- 隐藏账户：该帐户持有用于质押的绑定资金，但将一些功能委托给了控制者账户。因此，你可能会通过一个藏在冷钱包的密钥积极参与，这意味着它一直处于离线状态。您还可以指定一个代理帐户来对[治理](https://wiki.polkadot.network/docs/learn-governance)提案进行投票。

- 控制者账户：该帐户代表隐藏帐户，发出关于提名和验证的决定。它设定了支付账户和提交佣金等偏好。如果您是一个验证人，它还会设置[会话密钥](https://wiki.polkadot.network/docs/learn-keys#session-keys)。它只需要足够的资金支付交易费用。

我们设计了这种分离密钥类型的层次结构，以便验证人操作者和提名人能够比只有一个密钥的系统更好地保护自己。通常，只要您将一个密钥用于多个角色，或者即使您使用与派生相关的密钥，您就会失去安全性。你不应该使用任何帐户密钥作为特别的“热”会话密钥。

控制者账户和隐藏帐户密钥可以是sr25519或ed25519。有关Polkadot中如何使用密钥及其背后的密码学的更多信息，请[参见这里](https://wiki.polkadot.network/docs/learn-keys)。

## 验证人和提名人
由于验证人的名额是有限的，大多数的验证人是需要质押DOT并为网络经济安全做出贡献的人才会被提名。

验证人会完成大部分繁重的工作:它们会在BABE中产生新的候选区块，在GRANDPA中投票并达成共识，验证平行链的状态转换功能，可能还负责其他一些有关数据可用性和XCM的职责。

另一方面，提名人的责任要少得多。包括监控验证人的性能(正常运行时间)，关注不断变化的佣金率(验证人可以在任何时候更改区块佣金)，以及对其及其验证人帐户的一般健康状况进行监控。因此，与验证人相比，提名人的经验是相对不干涉的，而不是一定了事。
![validator and nomination](https://cdn.jsdelivr.net/gh/VegeBun-csj/Images/1011653814345_.pic.jpg)

### 想要质押DOT？
* [提名人指南](https://wiki.polkadot.network/docs/maintain-guides-how-to-nominate-polkadot) 成为波卡网络上的提名人
* [验证人指南](https://wiki.polkadot.network/docs/maintain-guides-how-to-validate-polkadot) 成为波卡网络上的验证人

## 削减
如果网络中的验证人有不当行为（例如，脱机，攻击网络或运行修改的软件），就会发生削减。验证人和他们的提名人会因此失去一定比例的绑定资金/质押金额。

任何被削减的DOT都将被纳入[国库](https://wiki.polkadot.network/docs/learn-treasury)。这样做的理由(而不是将其销毁或作为奖励分发)是，理事会只需从国库进行支付就可以恢复削减。这在一些情况下非常有用，比如运行时错误导致大幅削减，或者由于本身没有错误而迫使验证人离线。在合法削减的情况下，这种机制可以将代币从恶意验证人转移到那些通过正常的国库流程构建生态系统的人。

与不太受欢迎的验证人相比，支持它们的验证人池将受到更严厉的削减，所以我们鼓励提名人将他们的提名转移到不太受欢迎的验证人，以减少他们可能的损失。

重要的是要认识到，削减只发生在给定提名人的活跃的验证中，而削减不会因为有其他不活跃或等待的提名而减轻。它们也不能通过运行单独的验证人来缓解;每个验证人都被认为是自己的实体，和它们为了获得奖励的情况类似。

举个例子，假设BIG COMPANY有50个验证人同时离线，从而导致由于验证人的无响应对其提名人进行1%的削减。在这个例子中,提名人提名5个验证人,有2个是属于BIG_COMPANY(BC_1 and BC_2),其他3个验证人,不属于BIG_COMPANY(OV_1、OV_2和OV 3)。在这个era阶段,BC_1是这个提名人的活跃验证人,BC_2和OV_1是不活跃的,OV_2和OV_3在等待。提名人将被削减1%的绑定金额，因为BC_1是活跃的验证人。不活跃和等待的验证人(BC_2和OV_1到3)对此没有任何影响，因为它们没有活跃地验证。任何活跃地提名BC_2的提名人也会被削减1%，但任何提名OV_1的提名人不受影响。

在极少数情况下，一个提名人可能会在一个时间间隔内活跃地提名几名验证人。在这种情况下，削减金额与特定验证人质押金额数量成比例。例如，如果一位提名人将其50%的股份分给BC_1和OV_1，他们将获得0.5%的大幅削减(1%的50%)。如果一个提名人活跃地提名BC_1和BC_2，同样将他们50%的股份分配给每个人，他们仍然会以1%的削减结束，因为1%的削减适用于他们的一半股份。请注意，您不能控制分配给eac的股权比例











































